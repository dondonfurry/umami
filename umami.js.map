{"version":3,"sources":["umami.js"],"names":[],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"umami.js","sourcesContent":["(function() {\n\n\tconsole.clear();\n\tif (typeof browser === \"undefined\") {\n\t\tif (typeof chrome === \"undefined\") {\n\t\t\tconsole.log(\"UMAMI\", \"COULD NOT FIND BROWSER OR CHROME\");\n\t\t\treturn;\n\t\t}\n\t\tbrowser = chrome;\n\t}\n\n\t// window.setInterval(() => {\n\t//     browser.runtime.sendMessage({\n\t//         from_background: \"BEEP\",\n\t//     });\n\t// }, 1000);\n\n\tbrowser.runtime.onMessage.addListener(onMessage);\n\n\tconst umamiTabs = {};\n\n\tconst sendToTabs = (type, data) => {\n\t\tbrowser.tabs.query({}).then(tabs => {\n\t\t\tconst tabIDs = tabs.map(tab => parseInt(tab.id));\n\t\t\tumamiTabs.forEach((tab, k) => {\n\t\t\t\tif (tabIDs.includes(parseInt(tab.id))) {\n\t\t\t\t\tbrowser.tabs.sendMessage(tab.id, { type: type, data: data, src: \"umami-background\" });\n\t\t\t\t} else {\n\t\t\t\t\tdelete umamiTabs[k];\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t};\n\n\ts2t = sendToTabs;\n\n\tconsole.log(\"UMAMI\", \"INIT\");\n\n\tconst bulkDLs = {};\n\tconst activeBulkDLs = {};\n\tlet bulkDlInterval = null;\n\n\tconst cleanFileName = name => name.replace(/[^a-z0-9 \\\\\\/\\(\\)\\.\\-\\[\\]]/gi, '_');\n\tconst cleanFolderName = name => name.replace(/[^a-z0-9 \\(\\)\\.\\-\\[\\]]/gi, '_');\n\n\tconst bulkDL = (files, folder, root, id) => {\n\t\tfiles = JSON.parse(JSON.stringify(files));\n\n\t\tconst key = \"bdl\" + Date.now();\n\n\t\tbulkDLs[key] = {\n\t\t\tid: id,\n\t\t\troot: root || \"\",\n\t\t\tfolder: folder,\n\t\t\tfiles: files,\n\t\t\tcount: files.length,\n\t\t\tdone: [],\n\t\t};\n\n\t\tif (bulkDlInterval === null) {\n\t\t\twindow.setInterval(startBulkDL, 200);\n\t\t}\n\t};\n\n\tconst completeBulkDL = (key) => {\n\t\tbrowser.downloads.show(bulkDLs[key].done[0]);\n\t\tdelete bulkDLs[key];\n\t};\n\n\tconst completeBulkDLItem = (obj) => {\n\t\tconst id = obj.id;\n\t\tconst key = activeBulkDLs[id];\n\t\tconst dl = bulkDLs[key];\n\t\tdl.done.push(id);\n\t\tbrowser.downloads.erase({ id: id }).then(() => {\n\t\t\tconsole.log(\"ERASED\", id);\n\t\t\tsendToTabs(\"bulk_dl_step\", { id: dl.id, count: dl.count, done: dl.done.length, name: dl.folder, file: \"file\" });\n\t\t\tif (bulkDLs[key].done.length === bulkDLs[key].count) {\n\t\t\t\tcompleteBulkDL(key);\n\t\t\t}\n\t\t\tdelete activeBulkDLs[id];\n\t\t});\n\t};\n\n\tconst pathCombine = (arr) => arr.join(\"/\").split(\"/\").map(val => val.trim()).filter(val => val.length).join(\"/\");\n\n\tconst getBulkDL = () => {\n\t\tconst key = Object.keys(bulkDLs).sort().shift();\n\t\tif (typeof key === \"undefined\") return null;\n\t\tconst result = { key: key };\n\t\tconst folder = cleanFolderName(bulkDLs[key].folder);\n\t\tconst root = cleanFolderName(bulkDLs[key].root);\n\t\tconst file = bulkDLs[key].files.shift();\n\t\tif (typeof file === \"undefined\") {\n\t\t\tresult.file = null;\n\t\t} else {\n\t\t\tresult.url = file.url;\n\t\t\tresult.file = pathCombine([root, folder, cleanFileName(file.name)]);\n\t\t}\n\t\treturn result;\n\t};\n\n\tconst startBulkDL = () => {\n\t\tif (Object.keys(activeBulkDLs).length >= 5) {\n\t\t\treturn;\n\t\t}\n\t\tconst dl = getBulkDL();\n\t\tif (dl === null) {\n\t\t\twindow.clearInterval(bulkDlInterval);\n\t\t\tbulkDlInterval = null;\n\t\t\treturn;\n\t\t}\n\t\tif (dl.file === null) {\n\t\t\treturn;\n\t\t}\n\t\tconst fake = \"p\" + Date.now();\n\t\tactiveBulkDLs[fake] = false;\n\t\tbrowser.downloads.download({\n\t\t\turl: dl.url,\n\t\t\tfilename: dl.file,\n\t\t\tsaveAs: false,\n\t\t\tconflictAction: browser.downloads.FilenameConflictAction.OVERWRITE,\n\t\t}).then((dlID) => {\n\t\t\tactiveBulkDLs[dlID] = dl.key;\n\t\t\tdelete activeBulkDLs[fake];\n\t\t}).catch(e => {\n\t\t\tdelete activeBulkDLs[fake];\n\t\t});\n\t};\n\n\tconst bulkDLChange = (obj) => {\n\t\tconst id = obj.id;\n\t\tif (typeof activeBulkDLs[id] === \"string\") {\n\t\t\tif (obj.state.current === \"complete\") {\n\t\t\t\twindow.setTimeout(() => {\n\t\t\t\t\tcompleteBulkDLItem(obj);\n\t\t\t\t}, 500);\n\t\t\t}\n\t\t}\n\t};\n\n\tbrowser.downloads.onChanged.addListener(bulkDLChange);\n\n\tlet commands = {\n\t\topenTab: (cmd) => {\n\t\t\treturn new Promise((res, rej) => {\n\t\t\t\tbrowser.tabs.create({\n\t\t\t\t\tactive: true,\n\t\t\t\t\turl: cmd.url,\n\t\t\t\t});\n\t\t\t\tres(\"done\");\n\t\t\t});\n\t\t},\n\t\tdownload: (cmd) => {\n\t\t\treturn new Promise((res, rej) => {\n\t\t\t\tbrowser.downloads.download({\n\t\t\t\t\turl: cmd.url,\n\t\t\t\t\tfilename: cmd.filename,\n\t\t\t\t});\n\t\t\t\tres(\"done\");\n\t\t\t});\n\t\t},\n\t\tbulk_download: cmd => {\n\t\t\tbulkDL(cmd.files, cmd.foldername, cmd.root, cmd.id);\n\t\t\treturn Promise.resolve();\n\t\t},\n\t\trequest: request,\n\t\topenUri: data => {\n\t\t\treturn commands.openTab({ url: data.uri });\n\t\t},\n\t\tping: () => Promise.resolve(),\n\t};\n\n\t// commands.openTab(\n\t//     {\n\t//         url: 'tg://msg_url?url=https://static1.e926.net/data/sample/59/7d/597dab4e8ff4bfdd0fc87878beb485c9.jpg&text=LOOK NOT PORN'\n\t//     }\n\t// );\n\n\tfunction runCommand(type, data) {\n\t\tif (commands.hasOwnProperty(type)) {\n\t\t\tif (typeof commands[type] === \"function\") {\n\t\t\t\treturn commands[type](data);\n\t\t\t}\n\t\t}\n\t\tconsole.log(\"MISSING COMMAND\", type);\n\t\treturn Promise.reject({ err: \"NO FUNC TYPE\" });\n\t}\n\n\tfunction onMessage(message, sender, sr) {\n\t\tconst { type, data, src } = message;\n\t\tif (src !== \"umami-content\") return;\n\t\tumamiTabs[sender.tab.id] = sender.tab;\n\t\ttry {\n\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\ttry {\n\t\t\t\t\trunCommand(type, data)\n\t\t\t\t\t\t.then(resolve)\n\t\t\t\t\t\t.catch(reject);\n\t\t\t\t} catch (e) {\n\t\t\t\t\tconsole.log(\"onmsg prom error\", e);\n\t\t\t\t\treject(e);\n\t\t\t\t}\n\t\t\t});\n\t\t} catch (e) {\n\t\t\tconsole.log(\"onmsg error\", e);\n\t\t\treturn Promise.reject(e);\n\t\t}\n\t}\n\n\tfunction processRequest() {\n\t\tconst request = pendingReqs.shift();\n\t\tconst data = request.data;\n\t\tconst resolve = request.resolve;\n\t\tconst reject = request.reject;\n\t\tlet url = data.url;\n\t\tlet params = data.params || {};\n\t\tif (params.query) {\n\t\t\turl += (url.indexOf('?') === -1 ? '?' : '&') + queryParams(params.query);\n\t\t\tdelete params.query;\n\t\t}\n\n\t\tfetch(url, params)\n\t\t\t.then(requestResponseCast)\n\t\t\t.then(resolve)\n\t\t\t.catch(reject)\n\t\t\t.finally(() => {\n\t\t\t\treqTimeout = null;\n\t\t\t\tif (pendingReqs.length > 0) {\n\t\t\t\t\treqTimeout = setTimeout(processRequest, 1000);\n\t\t\t\t}\n\t\t\t});\n\t}\n\n\tlet reqTimeout = null;\n\tconst pendingReqs = [];\n\n\tfunction request(data) {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tpendingReqs.push({\n\t\t\t\tdata: data,\n\t\t\t\tresolve: resolve,\n\t\t\t\treject: reject,\n\t\t\t});\n\t\t\tif (reqTimeout === null) {\n\t\t\t\treqTimeout = setTimeout(processRequest, 1);\n\t\t\t}\n\t\t});\n\t}\n\n\tfunction requestResponseCast(response) {\n\t\tconst contentType = response.headers.get(\"content-type\");\n\t\tif (contentType && contentType.indexOf(\"application/json\") !== -1) {\n\t\t\ttry {\n\t\t\t\treturn response.json();\n\t\t\t} catch (e) {\n\n\t\t\t}\n\t\t}\n\t\treturn response.text();\n\t}\n\n\tfunction queryParams(params) {\n\t\treturn Object.keys(params)\n\t\t\t.map(k => encodeURIComponent(k) + '=' + encodeURIComponent(params[k]))\n\t\t\t.join('&');\n\t}\n\n\t// function notify(msg) {\n\t//     browser.notifications.create({\n\t//         \"type\": \"basic\",\n\t//         \"iconUrl\": browser.extension.getURL(\"icons/salt.png\"),\n\t//         \"title\": \"You clicked a link!\",\n\t//         \"message\": msg\n\t//     });\n\t// }\n\n})();"]}